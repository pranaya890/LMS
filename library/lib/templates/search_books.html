{% extends 'base.html' %}

{% load highlight %}

{% block content %}
<style>
  .search-container { margin:24px auto; max-width:900px; }
  h2 { color:#2c3e50; margin-bottom:20px; }
  h3 { color:#555; margin-top:24px; margin-bottom:16px; }
  .search-form { background:white; padding:16px; border-radius:4px; margin-bottom:20px; display:flex; gap:8px; }
  .search-form input { flex:1; padding:10px; border:1px solid #ddd; border-radius:4px; }
  .search-form button { padding:10px 20px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer; }
  .search-form button:hover { background:#0b7dda; }
  table { width:100%; border-collapse:collapse; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
  th { background:#2196F3; color:white; padding:12px; text-align:left; }
  td { padding:12px; border-bottom:1px solid #ddd; }
  tr:hover { background:#f5f5f5; }
  img { max-width:50px; max-height:50px; border-radius:4px; }
  mark.highlight { background: #ffeb3b; padding: 0 2px; border-radius:2px; }
</style>

<div class="search-container">
    <h2>üîç Search Books</h2>
    
    <div class="search-form">
    <form id="search-books-form" method="get" action="" style="width:100%;display:flex;gap:8px;">
            <input id="search-books-input" type="text" name="q" placeholder="Search by book name" value="{{ query }}">
            <button type="submit">Search</button>
        </form>
    </div>

    <h3>Results{% if query %} for "{{ query }}"{% endif %}</h3>
    
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Rating</th>
                <th>ISBN</th>
                <th>Author</th>
                <th>Category</th>
                <th>Stock</th>
                <th>Image</th>
            </tr>
        </thead>
        <tbody id="search-results-body">
            {% for book in books %}
            <tr {% if book.category %}data-category-id="{{ book.category.id }}"{% endif %}>
                <td><a href="{% url 'book_details' book.pk %}" style="color:#2196F3;text-decoration:none;">{% if query %}{{ book.name|highlight:query }}{% else %}{{ book.name }}{% endif %}</a></td>
                <td>{{ book.isbn }}</td>
                <td>{% if query %}{{ book.author|highlight:query }}{% else %}{{ book.author }}{% endif %}</td>
                <td>{% if query %}{{ book.category.name|highlight:query }}{% else %}{{ book.category.name }}{% endif %}</td>
                <td>{{ book.number_in_stock }}</td>
                <td>
                    {% if book.image %}
                        <img src="{{ book.image.url }}" alt="{{ book.name }}">
                    {% else %}
                        No image
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" style="text-align:center;color:#999;">No books found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('search-books-input');
    const resultsBody = document.getElementById('search-results-body');

    function debounce(fn, wait) {
        let t;
        return function(...args) {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), wait);
        };
    }

    function escapeHtml(str) {
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function highlightText(text, q) {
        if (!q) return escapeHtml(text);
        const re = new RegExp(q.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'ig');
        return escapeHtml(text).replace(re, match => `<mark class="highlight">${match}</mark>`);
    }

    async function fetchAndRender(q) {
        const url = `/ajax/search-books/?q=${encodeURIComponent(q || '')}`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Network error');
            const data = await res.json();
            // build tbody
            if (!data.books || data.books.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">No books found.</td></tr>';
                return;
            }
            // score and sort books so those with matches appear first; when query is empty, sort alphabetically
            function scoreBook(b, query) {
                if (!query) return 0;
                const pattern = new RegExp(query.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'ig');
                let s = 0;
                if (b.name && b.name.match(pattern)) s += (b.name.match(pattern) || []).length * 3;
                if (b.author && b.author.match(pattern)) s += (b.author.match(pattern) || []).length * 2;
                if (b.category && b.category.match(pattern)) s += (b.category.match(pattern) || []).length * 1;
                return s;
            }

            const term = (q || '').trim();
            if (!term) {
                data.books.sort((a, b) => (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' }));
            } else {
                data.books.sort((a, b) => scoreBook(b, term) - scoreBook(a, term));
            }

            const rows = data.books.map(b => {
                const dataAttr = b.category_id ? ` data-category-id="${escapeHtml(String(b.category_id))}"` : '';
                const name = `<a href="${escapeHtml(b.url)}" style="color:#2196F3;text-decoration:none;">${highlightText(b.name, term)}</a>`;
                const isbn = escapeHtml(b.isbn || '');
                const author = highlightText(b.author || '', term);
                const category = escapeHtml(b.category || '');
                const stock = escapeHtml(String(b.stock || ''));
                const img = b.image ? `<img src="${escapeHtml(b.image)}" alt="${escapeHtml(b.name)}" style="max-width:50px;max-height:50px;border-radius:4px;">` : 'No image';
                const ratingCell = b.combined_rating ? `‚≠ê ${escapeHtml(String(b.combined_rating))}/5` : '';
                return `<tr${dataAttr}><td>${name}</td><td>${ratingCell}</td><td>${isbn}</td><td>${author}</td><td>${category}</td><td>${stock}</td><td>${img}</td></tr>`;
            }).join('');
            resultsBody.innerHTML = rows;
        } catch (e) {
            console.error(e);
        }
    }

    const debouncedFetch = debounce(function() {
        fetchAndRender(input.value.trim());
    }, 250);

    input.addEventListener('input', function(e) {
        debouncedFetch();
    });
});
</script>

{% endblock %}
