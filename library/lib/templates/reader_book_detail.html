{% extends 'reader_base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .reader-book { display:flex; gap:20px; }
  .reader-meta { flex:2; }
  .reader-analytics { flex:1.5; }
  .analytics-card { background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:16px; }
  .analytics-card h3 { margin-top:0; color:#2c3e50; }
  .analytics-stat { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; }
  .analytics-stat:last-child { border-bottom:none; }
  .analytics-stat strong { color:#2980b9; }
  #readerIssuanceChart { max-height:300px; margin-top:12px; }
</style>

<div class="reader-book">
    <div>
        {% if book.image %}
            <img src="{{ book.image.url }}" alt="{{ book.name }}" style="max-width:240px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.06);">
        {% else %}
            <div style="width:240px;height:320px;display:flex;align-items:center;justify-content:center;background:#f3f3f3;color:#888;">No image</div>
        {% endif %}
    </div>

    <div class="reader-meta">
        <h2>{{ book.name }}</h2>
        <p><strong>Author:</strong> {{ book.author }}</p>
        <p><strong>ISBN:</strong> {{ book.isbn }}</p>
        <p><strong>Category:</strong> {{ book.category.name }}</p>
        <p><strong>Available Stock:</strong> {{ book.number_in_stock }}</p>
        <p id="rating-paragraph"><strong>Rating:</strong>
            {% if combined_rating %}
                ‚≠ê {{ combined_rating }}/5
                <small style="color:#666;">(Admin: {{ book.rating }} | Readers Avg: {{ avg_reader_rating }})</small>
            {% else %}
                ‚≠ê {{ book.rating }}/5
            {% endif %}
        </p>

        <div style="margin-top:12px;">
            <form id="rating-form" method="post" action="{% url 'rate_book' book.pk %}">
                {% csrf_token %}
                <label for="rating">Your Rating:</label>
                <div id="star-widget" style="display:inline-block;vertical-align:middle;margin-left:8px;">
                    <!-- stars will be clickable -->
                    <span class="star" data-value="1">‚òÜ</span>
                    <span class="star" data-value="2">‚òÜ</span>
                    <span class="star" data-value="3">‚òÜ</span>
                    <span class="star" data-value="4">‚òÜ</span>
                    <span class="star" data-value="5">‚òÜ</span>
                </div>
                <input type="hidden" name="rating" id="rating-input" value="">
                <div id="rating-feedback" style="margin-top:8px;color:green;display:none;"></div>
            </form>
        </div>

        {% if book.description %}
            <h4>Description</h4>
            <div>{{ book.description|linebreaksbr }}</div>
        {% else %}
            <p><em>No description available.</em></p>
        {% endif %}

        <div style="margin-top:12px;">
            {% if book.number_in_stock > 0 %}
                <form method="post" action="{% url 'issue_request' book.pk %}">
                    {% csrf_token %}
                    <button type="submit">Request Issue</button>
                </form>
            {% else %}
                <span style="color:#888">Out of Stock</span>
            {% endif %}
        </div>
    </div>

    <div class="reader-analytics">
        <div class="analytics-card">
            <h3>üìä Analytics (90 Days)</h3>
            <div class="analytics-stat">
                <span>Total Issued:</span>
                <strong>{{ analytics.total_issued }}</strong>
            </div>
            <div class="analytics-stat">
                <span>Avg per Day:</span>
                <strong>{{ analytics.avg_per_day|floatformat:2 }}</strong>
            </div>
            <canvas id="readerIssuanceChart"></canvas>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('readerIssuanceChart').getContext('2d');
    const dates = {{ analytics.dates|safe }};
    const quantities = {{ analytics.quantities|safe }};
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Books Issued',
                data: quantities,
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3,
                pointRadius: 3,
                pointBackgroundColor: '#4CAF50'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Quantity' }
                },
                x: {
                    title: { display: true, text: 'Date' }
                }
            }
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // expose admin rating to JS
    const BOOK_ADMIN_RATING = {{ book.rating|floatformat:1 }};
    const ratingInput = document.getElementById('rating-input');
    const stars = Array.from(document.querySelectorAll('#star-widget .star'));
    const feedback = document.getElementById('rating-feedback');
    const form = document.getElementById('rating-form');

    function highlightStars(n) {
        stars.forEach(s => {
            const v = parseInt(s.dataset.value, 10);
            if (v <= n) {
                s.textContent = '‚òÖ';
                s.style.color = 'gold';
            } else {
                s.textContent = '‚òÜ';
                s.style.color = '#ccc';
            }
        });
    }

    // handle star clicks (instant submit)
    stars.forEach(s => {
        s.style.cursor = 'pointer';
        s.style.fontSize = '22px';
        s.style.color = '#ccc';
        s.addEventListener('mouseenter', () => highlightStars(parseInt(s.dataset.value)));
        s.addEventListener('mouseleave', () => highlightStars(parseInt(ratingInput.value) || 0));
        s.addEventListener('click', () => {
            ratingInput.value = s.dataset.value;
            highlightStars(parseInt(s.dataset.value));

            // Immediately submit via AJAX
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData,
            }).then(r => r.json()).then(data => {
                if (data.error) {
                    feedback.style.display = 'block';
                    feedback.style.color = 'red';
                    feedback.textContent = data.error;
                    return;
                }
                // update rating display (replace contents of the paragraph)
                const ratingParagraph = document.getElementById('rating-paragraph');
                if (ratingParagraph) {
                    ratingParagraph.innerHTML = `<strong>Rating:</strong> ‚≠ê ${data.combined_rating}/5 <small style="color:#666;">(Admin: ${BOOK_ADMIN_RATING} | Readers Avg: ${data.avg_reader_rating})</small>`;
                }
                // update star highlights to match saved value
                ratingInput.value = String(data.user_rating || ratingInput.value);
                highlightStars(parseInt(ratingInput.value) || 0);
                feedback.style.display = 'block';
                feedback.style.color = 'green';
                feedback.textContent = 'Your rating has been saved.';
            }).catch(err => {
                feedback.style.display = 'block';
                feedback.style.color = 'red';
                feedback.textContent = 'Error submitting rating.';
            });
        });
    });

    // prefill if user_rating exists
    const initialUserRating = {{ user_rating|default:'null' }};
    if (initialUserRating) {
        ratingInput.value = String(initialUserRating);
        highlightStars(parseInt(initialUserRating));
    }
});
</script>

<section style="margin-top:32px;">
    <h2>‚≠ê Most Popular</h2>

    
    {% if popular_books %}
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;">
            {% for pop_book in popular_books %}
                <div style="border:1px solid #ddd;border-radius:8px;padding:12px;background:#f9f9f9;transition:box-shadow 0.2s;">
                    <div style="height:180px;background:#f0f0f0;border-radius:4px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
                        {% if pop_book.image %}
                            <img src="{{ pop_book.image.url }}" alt="{{ pop_book.name }}" style="width:100%;height:100%;object-fit:cover;">
                        {% else %}
                            <span style="color:#999;">No image</span>
                        {% endif %}
                    </div>
                    <h4 style="margin:8px 0;font-size:14px;">{{ pop_book.name }}</h4>
                    <p style="margin:4px 0;font-size:12px;color:#555;"><strong>Author:</strong> {{ pop_book.author }}</p>
                    <p style="margin:4px 0;font-size:12px;color:#555;"><strong>Rating:</strong> ‚≠ê {{ pop_book.rating }}/5</p>
                    <p style="margin:4px 0;font-size:12px;color:#555;"><strong>Stock:</strong> {{ pop_book.number_in_stock }}</p>
                    <a href="{% url 'reader_book_detail' pop_book.pk %}" style="display:inline-block;margin-top:8px;padding:6px 12px;background:#4CAF50;color:white;border-radius:4px;text-decoration:none;font-size:12px;">View Details</a>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color:#999;">No popular books available yet.</p>
    {% endif %}
</section>

{% endblock %}

